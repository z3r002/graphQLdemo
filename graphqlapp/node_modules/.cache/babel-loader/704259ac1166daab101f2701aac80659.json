{"ast":null,"code":"import { __assign, __extends } from \"tslib\";\nimport \"./fixPolyfills.js\";\nimport { dep, wrap } from 'optimism';\nimport { ApolloCache } from \"../core/cache.js\";\nimport { addTypenameToDocument, isReference } from \"../../utilities/index.js\";\nimport { StoreReader } from \"./readFromStore.js\";\nimport { StoreWriter } from \"./writeToStore.js\";\nimport { EntityStore, supportsResultCaching } from \"./entityStore.js\";\nimport { makeVar } from \"./reactiveVars.js\";\nimport { defaultDataIdFromObject, Policies } from \"./policies.js\";\nimport { hasOwn } from \"./helpers.js\";\nvar defaultConfig = {\n  dataIdFromObject: defaultDataIdFromObject,\n  addTypename: true,\n  resultCaching: true,\n  typePolicies: {}\n};\n\nvar InMemoryCache = function (_super) {\n  __extends(InMemoryCache, _super);\n\n  function InMemoryCache(config) {\n    if (config === void 0) {\n      config = {};\n    }\n\n    var _this = _super.call(this) || this;\n\n    _this.watches = new Set();\n    _this.typenameDocumentCache = new Map();\n    _this.makeVar = makeVar;\n    _this.txCount = 0;\n    _this.maybeBroadcastWatch = wrap(function (c, fromOptimisticTransaction) {\n      return _this.broadcastWatch.call(_this, c, !!fromOptimisticTransaction);\n    }, {\n      makeCacheKey: function (c) {\n        var store = c.optimistic ? _this.optimisticData : _this.data;\n\n        if (supportsResultCaching(store)) {\n          var optimistic = c.optimistic,\n              rootId = c.rootId,\n              variables = c.variables;\n          return store.makeCacheKey(c.query, c.callback, JSON.stringify({\n            optimistic: optimistic,\n            rootId: rootId,\n            variables: variables\n          }));\n        }\n      }\n    });\n    _this.watchDep = dep();\n    _this.config = __assign(__assign({}, defaultConfig), config);\n    _this.addTypename = !!_this.config.addTypename;\n    _this.policies = new Policies({\n      cache: _this,\n      dataIdFromObject: _this.config.dataIdFromObject,\n      possibleTypes: _this.config.possibleTypes,\n      typePolicies: _this.config.typePolicies\n    });\n    _this.data = new EntityStore.Root({\n      policies: _this.policies,\n      resultCaching: _this.config.resultCaching\n    });\n    _this.optimisticData = _this.data;\n    _this.storeWriter = new StoreWriter(_this, _this.storeReader = new StoreReader({\n      cache: _this,\n      addTypename: _this.addTypename\n    }));\n    return _this;\n  }\n\n  InMemoryCache.prototype.restore = function (data) {\n    if (data) this.data.replace(data);\n    return this;\n  };\n\n  InMemoryCache.prototype.extract = function (optimistic) {\n    if (optimistic === void 0) {\n      optimistic = false;\n    }\n\n    return (optimistic ? this.optimisticData : this.data).toObject();\n  };\n\n  InMemoryCache.prototype.read = function (options) {\n    var store = options.optimistic ? this.optimisticData : this.data;\n\n    if (typeof options.rootId === 'string' && !store.has(options.rootId)) {\n      return null;\n    }\n\n    return this.storeReader.diffQueryAgainstStore({\n      store: store,\n      query: options.query,\n      variables: options.variables,\n      rootId: options.rootId,\n      config: this.config,\n      returnPartialData: false\n    }).result || null;\n  };\n\n  InMemoryCache.prototype.write = function (options) {\n    try {\n      ++this.txCount;\n      return this.storeWriter.writeToStore({\n        store: this.data,\n        query: options.query,\n        result: options.result,\n        dataId: options.dataId,\n        variables: options.variables\n      });\n    } finally {\n      if (! --this.txCount && options.broadcast !== false) {\n        this.broadcastWatches();\n      }\n    }\n  };\n\n  InMemoryCache.prototype.modify = function (options) {\n    if (hasOwn.call(options, \"id\") && !options.id) {\n      return false;\n    }\n\n    var store = options.optimistic ? this.optimisticData : this.data;\n\n    try {\n      ++this.txCount;\n      return store.modify(options.id || \"ROOT_QUERY\", options.fields);\n    } finally {\n      if (! --this.txCount && options.broadcast !== false) {\n        this.broadcastWatches();\n      }\n    }\n  };\n\n  InMemoryCache.prototype.diff = function (options) {\n    return this.storeReader.diffQueryAgainstStore({\n      store: options.optimistic ? this.optimisticData : this.data,\n      rootId: options.id || \"ROOT_QUERY\",\n      query: options.query,\n      variables: options.variables,\n      returnPartialData: options.returnPartialData,\n      config: this.config\n    });\n  };\n\n  InMemoryCache.prototype.watch = function (watch) {\n    var _this = this;\n\n    this.watches.add(watch);\n\n    if (watch.immediate) {\n      this.maybeBroadcastWatch(watch);\n    }\n\n    return function () {\n      _this.watches.delete(watch);\n\n      _this.watchDep.dirty(watch);\n\n      _this.maybeBroadcastWatch.forget(watch);\n    };\n  };\n\n  InMemoryCache.prototype.gc = function () {\n    return this.optimisticData.gc();\n  };\n\n  InMemoryCache.prototype.retain = function (rootId, optimistic) {\n    return (optimistic ? this.optimisticData : this.data).retain(rootId);\n  };\n\n  InMemoryCache.prototype.release = function (rootId, optimistic) {\n    return (optimistic ? this.optimisticData : this.data).release(rootId);\n  };\n\n  InMemoryCache.prototype.identify = function (object) {\n    return isReference(object) ? object.__ref : this.policies.identify(object)[0];\n  };\n\n  InMemoryCache.prototype.evict = function (options) {\n    if (!options.id) {\n      if (hasOwn.call(options, \"id\")) {\n        return false;\n      }\n\n      options = __assign(__assign({}, options), {\n        id: \"ROOT_QUERY\"\n      });\n    }\n\n    try {\n      ++this.txCount;\n      return this.optimisticData.evict(options);\n    } finally {\n      if (! --this.txCount && options.broadcast !== false) {\n        this.broadcastWatches();\n      }\n    }\n  };\n\n  InMemoryCache.prototype.reset = function () {\n    this.data.clear();\n    this.optimisticData = this.data;\n    this.broadcastWatches();\n    return Promise.resolve();\n  };\n\n  InMemoryCache.prototype.removeOptimistic = function (idToRemove) {\n    var newOptimisticData = this.optimisticData.removeLayer(idToRemove);\n\n    if (newOptimisticData !== this.optimisticData) {\n      this.optimisticData = newOptimisticData;\n      this.broadcastWatches();\n    }\n  };\n\n  InMemoryCache.prototype.performTransaction = function (transaction, optimisticId) {\n    var _this = this;\n\n    var perform = function (layer) {\n      var _a = _this,\n          data = _a.data,\n          optimisticData = _a.optimisticData;\n      ++_this.txCount;\n\n      if (layer) {\n        _this.data = _this.optimisticData = layer;\n      }\n\n      try {\n        transaction(_this);\n      } finally {\n        --_this.txCount;\n        _this.data = data;\n        _this.optimisticData = optimisticData;\n      }\n    };\n\n    var fromOptimisticTransaction = false;\n\n    if (typeof optimisticId === 'string') {\n      this.optimisticData = this.optimisticData.addLayer(optimisticId, perform);\n      fromOptimisticTransaction = true;\n    } else if (optimisticId === null) {\n      perform(this.data);\n    } else {\n      perform();\n    }\n\n    this.broadcastWatches(fromOptimisticTransaction);\n  };\n\n  InMemoryCache.prototype.transformDocument = function (document) {\n    if (this.addTypename) {\n      var result = this.typenameDocumentCache.get(document);\n\n      if (!result) {\n        result = addTypenameToDocument(document);\n        this.typenameDocumentCache.set(document, result);\n        this.typenameDocumentCache.set(result, result);\n      }\n\n      return result;\n    }\n\n    return document;\n  };\n\n  InMemoryCache.prototype.broadcastWatches = function (fromOptimisticTransaction) {\n    var _this = this;\n\n    if (!this.txCount) {\n      this.watches.forEach(function (c) {\n        return _this.maybeBroadcastWatch(c, fromOptimisticTransaction);\n      });\n    }\n  };\n\n  InMemoryCache.prototype.broadcastWatch = function (c, fromOptimisticTransaction) {\n    this.watchDep.dirty(c);\n    this.watchDep(c);\n    var diff = this.diff({\n      query: c.query,\n      variables: c.variables,\n      optimistic: c.optimistic\n    });\n\n    if (c.optimistic && fromOptimisticTransaction) {\n      diff.fromOptimisticTransaction = true;\n    }\n\n    c.callback(diff);\n  };\n\n  return InMemoryCache;\n}(ApolloCache);\n\nexport { InMemoryCache };","map":{"version":3,"sources":["../../../src/cache/inmemory/inMemoryCache.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["import { __assign, __extends } from \"tslib\";\r\nimport \"./fixPolyfills.js\";\r\nimport { dep, wrap } from 'optimism';\r\nimport { ApolloCache } from \"../core/cache.js\";\r\nimport { addTypenameToDocument, isReference, } from \"../../utilities/index.js\";\r\nimport { StoreReader } from \"./readFromStore.js\";\r\nimport { StoreWriter } from \"./writeToStore.js\";\r\nimport { EntityStore, supportsResultCaching } from \"./entityStore.js\";\r\nimport { makeVar } from \"./reactiveVars.js\";\r\nimport { defaultDataIdFromObject, Policies, } from \"./policies.js\";\r\nimport { hasOwn } from \"./helpers.js\";\r\nvar defaultConfig = {\r\n    dataIdFromObject: defaultDataIdFromObject,\r\n    addTypename: true,\r\n    resultCaching: true,\r\n    typePolicies: {},\r\n};\r\nvar InMemoryCache = (function (_super) {\r\n    __extends(InMemoryCache, _super);\r\n    function InMemoryCache(config) {\r\n        if (config === void 0) { config = {}; }\r\n        var _this = _super.call(this) || this;\r\n        _this.watches = new Set();\r\n        _this.typenameDocumentCache = new Map();\r\n        _this.makeVar = makeVar;\r\n        _this.txCount = 0;\r\n        _this.maybeBroadcastWatch = wrap(function (c, fromOptimisticTransaction) {\r\n            return _this.broadcastWatch.call(_this, c, !!fromOptimisticTransaction);\r\n        }, {\r\n            makeCacheKey: function (c) {\r\n                var store = c.optimistic ? _this.optimisticData : _this.data;\r\n                if (supportsResultCaching(store)) {\r\n                    var optimistic = c.optimistic, rootId = c.rootId, variables = c.variables;\r\n                    return store.makeCacheKey(c.query, c.callback, JSON.stringify({ optimistic: optimistic, rootId: rootId, variables: variables }));\r\n                }\r\n            }\r\n        });\r\n        _this.watchDep = dep();\r\n        _this.config = __assign(__assign({}, defaultConfig), config);\r\n        _this.addTypename = !!_this.config.addTypename;\r\n        _this.policies = new Policies({\r\n            cache: _this,\r\n            dataIdFromObject: _this.config.dataIdFromObject,\r\n            possibleTypes: _this.config.possibleTypes,\r\n            typePolicies: _this.config.typePolicies,\r\n        });\r\n        _this.data = new EntityStore.Root({\r\n            policies: _this.policies,\r\n            resultCaching: _this.config.resultCaching,\r\n        });\r\n        _this.optimisticData = _this.data;\r\n        _this.storeWriter = new StoreWriter(_this, _this.storeReader = new StoreReader({\r\n            cache: _this,\r\n            addTypename: _this.addTypename,\r\n        }));\r\n        return _this;\r\n    }\r\n    InMemoryCache.prototype.restore = function (data) {\r\n        if (data)\r\n            this.data.replace(data);\r\n        return this;\r\n    };\r\n    InMemoryCache.prototype.extract = function (optimistic) {\r\n        if (optimistic === void 0) { optimistic = false; }\r\n        return (optimistic ? this.optimisticData : this.data).toObject();\r\n    };\r\n    InMemoryCache.prototype.read = function (options) {\r\n        var store = options.optimistic ? this.optimisticData : this.data;\r\n        if (typeof options.rootId === 'string' && !store.has(options.rootId)) {\r\n            return null;\r\n        }\r\n        return this.storeReader.diffQueryAgainstStore({\r\n            store: store,\r\n            query: options.query,\r\n            variables: options.variables,\r\n            rootId: options.rootId,\r\n            config: this.config,\r\n            returnPartialData: false,\r\n        }).result || null;\r\n    };\r\n    InMemoryCache.prototype.write = function (options) {\r\n        try {\r\n            ++this.txCount;\r\n            return this.storeWriter.writeToStore({\r\n                store: this.data,\r\n                query: options.query,\r\n                result: options.result,\r\n                dataId: options.dataId,\r\n                variables: options.variables,\r\n            });\r\n        }\r\n        finally {\r\n            if (!--this.txCount && options.broadcast !== false) {\r\n                this.broadcastWatches();\r\n            }\r\n        }\r\n    };\r\n    InMemoryCache.prototype.modify = function (options) {\r\n        if (hasOwn.call(options, \"id\") && !options.id) {\r\n            return false;\r\n        }\r\n        var store = options.optimistic\r\n            ? this.optimisticData\r\n            : this.data;\r\n        try {\r\n            ++this.txCount;\r\n            return store.modify(options.id || \"ROOT_QUERY\", options.fields);\r\n        }\r\n        finally {\r\n            if (!--this.txCount && options.broadcast !== false) {\r\n                this.broadcastWatches();\r\n            }\r\n        }\r\n    };\r\n    InMemoryCache.prototype.diff = function (options) {\r\n        return this.storeReader.diffQueryAgainstStore({\r\n            store: options.optimistic ? this.optimisticData : this.data,\r\n            rootId: options.id || \"ROOT_QUERY\",\r\n            query: options.query,\r\n            variables: options.variables,\r\n            returnPartialData: options.returnPartialData,\r\n            config: this.config,\r\n        });\r\n    };\r\n    InMemoryCache.prototype.watch = function (watch) {\r\n        var _this = this;\r\n        this.watches.add(watch);\r\n        if (watch.immediate) {\r\n            this.maybeBroadcastWatch(watch);\r\n        }\r\n        return function () {\r\n            _this.watches.delete(watch);\r\n            _this.watchDep.dirty(watch);\r\n            _this.maybeBroadcastWatch.forget(watch);\r\n        };\r\n    };\r\n    InMemoryCache.prototype.gc = function () {\r\n        return this.optimisticData.gc();\r\n    };\r\n    InMemoryCache.prototype.retain = function (rootId, optimistic) {\r\n        return (optimistic ? this.optimisticData : this.data).retain(rootId);\r\n    };\r\n    InMemoryCache.prototype.release = function (rootId, optimistic) {\r\n        return (optimistic ? this.optimisticData : this.data).release(rootId);\r\n    };\r\n    InMemoryCache.prototype.identify = function (object) {\r\n        return isReference(object) ? object.__ref :\r\n            this.policies.identify(object)[0];\r\n    };\r\n    InMemoryCache.prototype.evict = function (options) {\r\n        if (!options.id) {\r\n            if (hasOwn.call(options, \"id\")) {\r\n                return false;\r\n            }\r\n            options = __assign(__assign({}, options), { id: \"ROOT_QUERY\" });\r\n        }\r\n        try {\r\n            ++this.txCount;\r\n            return this.optimisticData.evict(options);\r\n        }\r\n        finally {\r\n            if (!--this.txCount && options.broadcast !== false) {\r\n                this.broadcastWatches();\r\n            }\r\n        }\r\n    };\r\n    InMemoryCache.prototype.reset = function () {\r\n        this.data.clear();\r\n        this.optimisticData = this.data;\r\n        this.broadcastWatches();\r\n        return Promise.resolve();\r\n    };\r\n    InMemoryCache.prototype.removeOptimistic = function (idToRemove) {\r\n        var newOptimisticData = this.optimisticData.removeLayer(idToRemove);\r\n        if (newOptimisticData !== this.optimisticData) {\r\n            this.optimisticData = newOptimisticData;\r\n            this.broadcastWatches();\r\n        }\r\n    };\r\n    InMemoryCache.prototype.performTransaction = function (transaction, optimisticId) {\r\n        var _this = this;\r\n        var perform = function (layer) {\r\n            var _a = _this, data = _a.data, optimisticData = _a.optimisticData;\r\n            ++_this.txCount;\r\n            if (layer) {\r\n                _this.data = _this.optimisticData = layer;\r\n            }\r\n            try {\r\n                transaction(_this);\r\n            }\r\n            finally {\r\n                --_this.txCount;\r\n                _this.data = data;\r\n                _this.optimisticData = optimisticData;\r\n            }\r\n        };\r\n        var fromOptimisticTransaction = false;\r\n        if (typeof optimisticId === 'string') {\r\n            this.optimisticData = this.optimisticData.addLayer(optimisticId, perform);\r\n            fromOptimisticTransaction = true;\r\n        }\r\n        else if (optimisticId === null) {\r\n            perform(this.data);\r\n        }\r\n        else {\r\n            perform();\r\n        }\r\n        this.broadcastWatches(fromOptimisticTransaction);\r\n    };\r\n    InMemoryCache.prototype.transformDocument = function (document) {\r\n        if (this.addTypename) {\r\n            var result = this.typenameDocumentCache.get(document);\r\n            if (!result) {\r\n                result = addTypenameToDocument(document);\r\n                this.typenameDocumentCache.set(document, result);\r\n                this.typenameDocumentCache.set(result, result);\r\n            }\r\n            return result;\r\n        }\r\n        return document;\r\n    };\r\n    InMemoryCache.prototype.broadcastWatches = function (fromOptimisticTransaction) {\r\n        var _this = this;\r\n        if (!this.txCount) {\r\n            this.watches.forEach(function (c) { return _this.maybeBroadcastWatch(c, fromOptimisticTransaction); });\r\n        }\r\n    };\r\n    InMemoryCache.prototype.broadcastWatch = function (c, fromOptimisticTransaction) {\r\n        this.watchDep.dirty(c);\r\n        this.watchDep(c);\r\n        var diff = this.diff({\r\n            query: c.query,\r\n            variables: c.variables,\r\n            optimistic: c.optimistic,\r\n        });\r\n        if (c.optimistic && fromOptimisticTransaction) {\r\n            diff.fromOptimisticTransaction = true;\r\n        }\r\n        c.callback(diff);\r\n    };\r\n    return InMemoryCache;\r\n}(ApolloCache));\r\nexport { InMemoryCache };\r\n//# sourceMappingURL=inMemoryCache.js.map"]},"metadata":{},"sourceType":"module"}