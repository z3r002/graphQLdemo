{"ast":null,"code":"import { __assign, __awaiter, __generator } from \"tslib\";\nimport { visit, BREAK } from 'graphql';\nimport { invariant } from 'ts-invariant';\nimport { argumentsObjectFromField, buildQueryFromSelectionSet, createFragmentMap, getFragmentDefinitions, getMainDefinition, hasDirectives, isField, isInlineFragment, mergeDeep, mergeDeepArray, removeClientSetsFromDocument, resultKeyNameFromField, shouldInclude } from \"../utilities/index.js\";\nimport { cacheSlot } from \"../cache/index.js\";\n\nvar LocalState = function () {\n  function LocalState(_a) {\n    var cache = _a.cache,\n        client = _a.client,\n        resolvers = _a.resolvers,\n        fragmentMatcher = _a.fragmentMatcher;\n    this.cache = cache;\n\n    if (client) {\n      this.client = client;\n    }\n\n    if (resolvers) {\n      this.addResolvers(resolvers);\n    }\n\n    if (fragmentMatcher) {\n      this.setFragmentMatcher(fragmentMatcher);\n    }\n  }\n\n  LocalState.prototype.addResolvers = function (resolvers) {\n    var _this = this;\n\n    this.resolvers = this.resolvers || {};\n\n    if (Array.isArray(resolvers)) {\n      resolvers.forEach(function (resolverGroup) {\n        _this.resolvers = mergeDeep(_this.resolvers, resolverGroup);\n      });\n    } else {\n      this.resolvers = mergeDeep(this.resolvers, resolvers);\n    }\n  };\n\n  LocalState.prototype.setResolvers = function (resolvers) {\n    this.resolvers = {};\n    this.addResolvers(resolvers);\n  };\n\n  LocalState.prototype.getResolvers = function () {\n    return this.resolvers || {};\n  };\n\n  LocalState.prototype.runResolvers = function (_a) {\n    var document = _a.document,\n        remoteResult = _a.remoteResult,\n        context = _a.context,\n        variables = _a.variables,\n        _b = _a.onlyRunForcedResolvers,\n        onlyRunForcedResolvers = _b === void 0 ? false : _b;\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_c) {\n        if (document) {\n          return [2, this.resolveDocument(document, remoteResult.data, context, variables, this.fragmentMatcher, onlyRunForcedResolvers).then(function (localResult) {\n            return __assign(__assign({}, remoteResult), {\n              data: localResult.result\n            });\n          })];\n        }\n\n        return [2, remoteResult];\n      });\n    });\n  };\n\n  LocalState.prototype.setFragmentMatcher = function (fragmentMatcher) {\n    this.fragmentMatcher = fragmentMatcher;\n  };\n\n  LocalState.prototype.getFragmentMatcher = function () {\n    return this.fragmentMatcher;\n  };\n\n  LocalState.prototype.clientQuery = function (document) {\n    if (hasDirectives(['client'], document)) {\n      if (this.resolvers) {\n        return document;\n      }\n    }\n\n    return null;\n  };\n\n  LocalState.prototype.serverQuery = function (document) {\n    return removeClientSetsFromDocument(document);\n  };\n\n  LocalState.prototype.prepareContext = function (context) {\n    var cache = this.cache;\n    return __assign(__assign({}, context), {\n      cache: cache,\n      getCacheKey: function (obj) {\n        return cache.identify(obj);\n      }\n    });\n  };\n\n  LocalState.prototype.addExportedVariables = function (document, variables, context) {\n    if (variables === void 0) {\n      variables = {};\n    }\n\n    if (context === void 0) {\n      context = {};\n    }\n\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        if (document) {\n          return [2, this.resolveDocument(document, this.buildRootValueFromCache(document, variables) || {}, this.prepareContext(context), variables).then(function (data) {\n            return __assign(__assign({}, variables), data.exportedVariables);\n          })];\n        }\n\n        return [2, __assign({}, variables)];\n      });\n    });\n  };\n\n  LocalState.prototype.shouldForceResolvers = function (document) {\n    var forceResolvers = false;\n    visit(document, {\n      Directive: {\n        enter: function (node) {\n          if (node.name.value === 'client' && node.arguments) {\n            forceResolvers = node.arguments.some(function (arg) {\n              return arg.name.value === 'always' && arg.value.kind === 'BooleanValue' && arg.value.value === true;\n            });\n\n            if (forceResolvers) {\n              return BREAK;\n            }\n          }\n        }\n      }\n    });\n    return forceResolvers;\n  };\n\n  LocalState.prototype.buildRootValueFromCache = function (document, variables) {\n    return this.cache.diff({\n      query: buildQueryFromSelectionSet(document),\n      variables: variables,\n      returnPartialData: true,\n      optimistic: false\n    }).result;\n  };\n\n  LocalState.prototype.resolveDocument = function (document, rootValue, context, variables, fragmentMatcher, onlyRunForcedResolvers) {\n    if (context === void 0) {\n      context = {};\n    }\n\n    if (variables === void 0) {\n      variables = {};\n    }\n\n    if (fragmentMatcher === void 0) {\n      fragmentMatcher = function () {\n        return true;\n      };\n    }\n\n    if (onlyRunForcedResolvers === void 0) {\n      onlyRunForcedResolvers = false;\n    }\n\n    return __awaiter(this, void 0, void 0, function () {\n      var mainDefinition, fragments, fragmentMap, definitionOperation, defaultOperationType, _a, cache, client, execContext;\n\n      return __generator(this, function (_b) {\n        mainDefinition = getMainDefinition(document);\n        fragments = getFragmentDefinitions(document);\n        fragmentMap = createFragmentMap(fragments);\n        definitionOperation = mainDefinition.operation;\n        defaultOperationType = definitionOperation ? definitionOperation.charAt(0).toUpperCase() + definitionOperation.slice(1) : 'Query';\n        _a = this, cache = _a.cache, client = _a.client;\n        execContext = {\n          fragmentMap: fragmentMap,\n          context: __assign(__assign({}, context), {\n            cache: cache,\n            client: client\n          }),\n          variables: variables,\n          fragmentMatcher: fragmentMatcher,\n          defaultOperationType: defaultOperationType,\n          exportedVariables: {},\n          onlyRunForcedResolvers: onlyRunForcedResolvers\n        };\n        return [2, this.resolveSelectionSet(mainDefinition.selectionSet, rootValue, execContext).then(function (result) {\n          return {\n            result: result,\n            exportedVariables: execContext.exportedVariables\n          };\n        })];\n      });\n    });\n  };\n\n  LocalState.prototype.resolveSelectionSet = function (selectionSet, rootValue, execContext) {\n    return __awaiter(this, void 0, void 0, function () {\n      var fragmentMap, context, variables, resultsToMerge, execute;\n\n      var _this = this;\n\n      return __generator(this, function (_a) {\n        fragmentMap = execContext.fragmentMap, context = execContext.context, variables = execContext.variables;\n        resultsToMerge = [rootValue];\n\n        execute = function (selection) {\n          return __awaiter(_this, void 0, void 0, function () {\n            var fragment, typeCondition;\n            return __generator(this, function (_a) {\n              if (!shouldInclude(selection, variables)) {\n                return [2];\n              }\n\n              if (isField(selection)) {\n                return [2, this.resolveField(selection, rootValue, execContext).then(function (fieldResult) {\n                  var _a;\n\n                  if (typeof fieldResult !== 'undefined') {\n                    resultsToMerge.push((_a = {}, _a[resultKeyNameFromField(selection)] = fieldResult, _a));\n                  }\n                })];\n              }\n\n              if (isInlineFragment(selection)) {\n                fragment = selection;\n              } else {\n                fragment = fragmentMap[selection.name.value];\n                process.env.NODE_ENV === \"production\" ? invariant(fragment, 11) : invariant(fragment, \"No fragment named \" + selection.name.value);\n              }\n\n              if (fragment && fragment.typeCondition) {\n                typeCondition = fragment.typeCondition.name.value;\n\n                if (execContext.fragmentMatcher(rootValue, typeCondition, context)) {\n                  return [2, this.resolveSelectionSet(fragment.selectionSet, rootValue, execContext).then(function (fragmentResult) {\n                    resultsToMerge.push(fragmentResult);\n                  })];\n                }\n              }\n\n              return [2];\n            });\n          });\n        };\n\n        return [2, Promise.all(selectionSet.selections.map(execute)).then(function () {\n          return mergeDeepArray(resultsToMerge);\n        })];\n      });\n    });\n  };\n\n  LocalState.prototype.resolveField = function (field, rootValue, execContext) {\n    return __awaiter(this, void 0, void 0, function () {\n      var variables, fieldName, aliasedFieldName, aliasUsed, defaultResult, resultPromise, resolverType, resolverMap, resolve;\n\n      var _this = this;\n\n      return __generator(this, function (_a) {\n        variables = execContext.variables;\n        fieldName = field.name.value;\n        aliasedFieldName = resultKeyNameFromField(field);\n        aliasUsed = fieldName !== aliasedFieldName;\n        defaultResult = rootValue[aliasedFieldName] || rootValue[fieldName];\n        resultPromise = Promise.resolve(defaultResult);\n\n        if (!execContext.onlyRunForcedResolvers || this.shouldForceResolvers(field)) {\n          resolverType = rootValue.__typename || execContext.defaultOperationType;\n          resolverMap = this.resolvers && this.resolvers[resolverType];\n\n          if (resolverMap) {\n            resolve = resolverMap[aliasUsed ? fieldName : aliasedFieldName];\n\n            if (resolve) {\n              resultPromise = Promise.resolve(cacheSlot.withValue(this.cache, resolve, [rootValue, argumentsObjectFromField(field, variables), execContext.context, {\n                field: field,\n                fragmentMap: execContext.fragmentMap\n              }]));\n            }\n          }\n        }\n\n        return [2, resultPromise.then(function (result) {\n          if (result === void 0) {\n            result = defaultResult;\n          }\n\n          if (field.directives) {\n            field.directives.forEach(function (directive) {\n              if (directive.name.value === 'export' && directive.arguments) {\n                directive.arguments.forEach(function (arg) {\n                  if (arg.name.value === 'as' && arg.value.kind === 'StringValue') {\n                    execContext.exportedVariables[arg.value.value] = result;\n                  }\n                });\n              }\n            });\n          }\n\n          if (!field.selectionSet) {\n            return result;\n          }\n\n          if (result == null) {\n            return result;\n          }\n\n          if (Array.isArray(result)) {\n            return _this.resolveSubSelectedArray(field, result, execContext);\n          }\n\n          if (field.selectionSet) {\n            return _this.resolveSelectionSet(field.selectionSet, result, execContext);\n          }\n        })];\n      });\n    });\n  };\n\n  LocalState.prototype.resolveSubSelectedArray = function (field, result, execContext) {\n    var _this = this;\n\n    return Promise.all(result.map(function (item) {\n      if (item === null) {\n        return null;\n      }\n\n      if (Array.isArray(item)) {\n        return _this.resolveSubSelectedArray(field, item, execContext);\n      }\n\n      if (field.selectionSet) {\n        return _this.resolveSelectionSet(field.selectionSet, item, execContext);\n      }\n    }));\n  };\n\n  return LocalState;\n}();\n\nexport { LocalState };","map":{"version":3,"sources":["../../src/core/LocalState.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["import { __assign, __awaiter, __generator } from \"tslib\";\r\nimport { visit, BREAK, } from 'graphql';\r\nimport { invariant } from 'ts-invariant';\r\nimport { argumentsObjectFromField, buildQueryFromSelectionSet, createFragmentMap, getFragmentDefinitions, getMainDefinition, hasDirectives, isField, isInlineFragment, mergeDeep, mergeDeepArray, removeClientSetsFromDocument, resultKeyNameFromField, shouldInclude, } from \"../utilities/index.js\";\r\nimport { cacheSlot } from \"../cache/index.js\";\r\nvar LocalState = (function () {\r\n    function LocalState(_a) {\r\n        var cache = _a.cache, client = _a.client, resolvers = _a.resolvers, fragmentMatcher = _a.fragmentMatcher;\r\n        this.cache = cache;\r\n        if (client) {\r\n            this.client = client;\r\n        }\r\n        if (resolvers) {\r\n            this.addResolvers(resolvers);\r\n        }\r\n        if (fragmentMatcher) {\r\n            this.setFragmentMatcher(fragmentMatcher);\r\n        }\r\n    }\r\n    LocalState.prototype.addResolvers = function (resolvers) {\r\n        var _this = this;\r\n        this.resolvers = this.resolvers || {};\r\n        if (Array.isArray(resolvers)) {\r\n            resolvers.forEach(function (resolverGroup) {\r\n                _this.resolvers = mergeDeep(_this.resolvers, resolverGroup);\r\n            });\r\n        }\r\n        else {\r\n            this.resolvers = mergeDeep(this.resolvers, resolvers);\r\n        }\r\n    };\r\n    LocalState.prototype.setResolvers = function (resolvers) {\r\n        this.resolvers = {};\r\n        this.addResolvers(resolvers);\r\n    };\r\n    LocalState.prototype.getResolvers = function () {\r\n        return this.resolvers || {};\r\n    };\r\n    LocalState.prototype.runResolvers = function (_a) {\r\n        var document = _a.document, remoteResult = _a.remoteResult, context = _a.context, variables = _a.variables, _b = _a.onlyRunForcedResolvers, onlyRunForcedResolvers = _b === void 0 ? false : _b;\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            return __generator(this, function (_c) {\r\n                if (document) {\r\n                    return [2, this.resolveDocument(document, remoteResult.data, context, variables, this.fragmentMatcher, onlyRunForcedResolvers).then(function (localResult) { return (__assign(__assign({}, remoteResult), { data: localResult.result })); })];\r\n                }\r\n                return [2, remoteResult];\r\n            });\r\n        });\r\n    };\r\n    LocalState.prototype.setFragmentMatcher = function (fragmentMatcher) {\r\n        this.fragmentMatcher = fragmentMatcher;\r\n    };\r\n    LocalState.prototype.getFragmentMatcher = function () {\r\n        return this.fragmentMatcher;\r\n    };\r\n    LocalState.prototype.clientQuery = function (document) {\r\n        if (hasDirectives(['client'], document)) {\r\n            if (this.resolvers) {\r\n                return document;\r\n            }\r\n        }\r\n        return null;\r\n    };\r\n    LocalState.prototype.serverQuery = function (document) {\r\n        return removeClientSetsFromDocument(document);\r\n    };\r\n    LocalState.prototype.prepareContext = function (context) {\r\n        var cache = this.cache;\r\n        return __assign(__assign({}, context), { cache: cache,\r\n            getCacheKey: function (obj) {\r\n                return cache.identify(obj);\r\n            } });\r\n    };\r\n    LocalState.prototype.addExportedVariables = function (document, variables, context) {\r\n        if (variables === void 0) { variables = {}; }\r\n        if (context === void 0) { context = {}; }\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            return __generator(this, function (_a) {\r\n                if (document) {\r\n                    return [2, this.resolveDocument(document, this.buildRootValueFromCache(document, variables) || {}, this.prepareContext(context), variables).then(function (data) { return (__assign(__assign({}, variables), data.exportedVariables)); })];\r\n                }\r\n                return [2, __assign({}, variables)];\r\n            });\r\n        });\r\n    };\r\n    LocalState.prototype.shouldForceResolvers = function (document) {\r\n        var forceResolvers = false;\r\n        visit(document, {\r\n            Directive: {\r\n                enter: function (node) {\r\n                    if (node.name.value === 'client' && node.arguments) {\r\n                        forceResolvers = node.arguments.some(function (arg) {\r\n                            return arg.name.value === 'always' &&\r\n                                arg.value.kind === 'BooleanValue' &&\r\n                                arg.value.value === true;\r\n                        });\r\n                        if (forceResolvers) {\r\n                            return BREAK;\r\n                        }\r\n                    }\r\n                },\r\n            },\r\n        });\r\n        return forceResolvers;\r\n    };\r\n    LocalState.prototype.buildRootValueFromCache = function (document, variables) {\r\n        return this.cache.diff({\r\n            query: buildQueryFromSelectionSet(document),\r\n            variables: variables,\r\n            returnPartialData: true,\r\n            optimistic: false,\r\n        }).result;\r\n    };\r\n    LocalState.prototype.resolveDocument = function (document, rootValue, context, variables, fragmentMatcher, onlyRunForcedResolvers) {\r\n        if (context === void 0) { context = {}; }\r\n        if (variables === void 0) { variables = {}; }\r\n        if (fragmentMatcher === void 0) { fragmentMatcher = function () { return true; }; }\r\n        if (onlyRunForcedResolvers === void 0) { onlyRunForcedResolvers = false; }\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var mainDefinition, fragments, fragmentMap, definitionOperation, defaultOperationType, _a, cache, client, execContext;\r\n            return __generator(this, function (_b) {\r\n                mainDefinition = getMainDefinition(document);\r\n                fragments = getFragmentDefinitions(document);\r\n                fragmentMap = createFragmentMap(fragments);\r\n                definitionOperation = mainDefinition\r\n                    .operation;\r\n                defaultOperationType = definitionOperation\r\n                    ? definitionOperation.charAt(0).toUpperCase() +\r\n                        definitionOperation.slice(1)\r\n                    : 'Query';\r\n                _a = this, cache = _a.cache, client = _a.client;\r\n                execContext = {\r\n                    fragmentMap: fragmentMap,\r\n                    context: __assign(__assign({}, context), { cache: cache,\r\n                        client: client }),\r\n                    variables: variables,\r\n                    fragmentMatcher: fragmentMatcher,\r\n                    defaultOperationType: defaultOperationType,\r\n                    exportedVariables: {},\r\n                    onlyRunForcedResolvers: onlyRunForcedResolvers,\r\n                };\r\n                return [2, this.resolveSelectionSet(mainDefinition.selectionSet, rootValue, execContext).then(function (result) { return ({\r\n                        result: result,\r\n                        exportedVariables: execContext.exportedVariables,\r\n                    }); })];\r\n            });\r\n        });\r\n    };\r\n    LocalState.prototype.resolveSelectionSet = function (selectionSet, rootValue, execContext) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var fragmentMap, context, variables, resultsToMerge, execute;\r\n            var _this = this;\r\n            return __generator(this, function (_a) {\r\n                fragmentMap = execContext.fragmentMap, context = execContext.context, variables = execContext.variables;\r\n                resultsToMerge = [rootValue];\r\n                execute = function (selection) { return __awaiter(_this, void 0, void 0, function () {\r\n                    var fragment, typeCondition;\r\n                    return __generator(this, function (_a) {\r\n                        if (!shouldInclude(selection, variables)) {\r\n                            return [2];\r\n                        }\r\n                        if (isField(selection)) {\r\n                            return [2, this.resolveField(selection, rootValue, execContext).then(function (fieldResult) {\r\n                                    var _a;\r\n                                    if (typeof fieldResult !== 'undefined') {\r\n                                        resultsToMerge.push((_a = {},\r\n                                            _a[resultKeyNameFromField(selection)] = fieldResult,\r\n                                            _a));\r\n                                    }\r\n                                })];\r\n                        }\r\n                        if (isInlineFragment(selection)) {\r\n                            fragment = selection;\r\n                        }\r\n                        else {\r\n                            fragment = fragmentMap[selection.name.value];\r\n                            process.env.NODE_ENV === \"production\" ? invariant(fragment, 11) : invariant(fragment, \"No fragment named \" + selection.name.value);\r\n                        }\r\n                        if (fragment && fragment.typeCondition) {\r\n                            typeCondition = fragment.typeCondition.name.value;\r\n                            if (execContext.fragmentMatcher(rootValue, typeCondition, context)) {\r\n                                return [2, this.resolveSelectionSet(fragment.selectionSet, rootValue, execContext).then(function (fragmentResult) {\r\n                                        resultsToMerge.push(fragmentResult);\r\n                                    })];\r\n                            }\r\n                        }\r\n                        return [2];\r\n                    });\r\n                }); };\r\n                return [2, Promise.all(selectionSet.selections.map(execute)).then(function () {\r\n                        return mergeDeepArray(resultsToMerge);\r\n                    })];\r\n            });\r\n        });\r\n    };\r\n    LocalState.prototype.resolveField = function (field, rootValue, execContext) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var variables, fieldName, aliasedFieldName, aliasUsed, defaultResult, resultPromise, resolverType, resolverMap, resolve;\r\n            var _this = this;\r\n            return __generator(this, function (_a) {\r\n                variables = execContext.variables;\r\n                fieldName = field.name.value;\r\n                aliasedFieldName = resultKeyNameFromField(field);\r\n                aliasUsed = fieldName !== aliasedFieldName;\r\n                defaultResult = rootValue[aliasedFieldName] || rootValue[fieldName];\r\n                resultPromise = Promise.resolve(defaultResult);\r\n                if (!execContext.onlyRunForcedResolvers ||\r\n                    this.shouldForceResolvers(field)) {\r\n                    resolverType = rootValue.__typename || execContext.defaultOperationType;\r\n                    resolverMap = this.resolvers && this.resolvers[resolverType];\r\n                    if (resolverMap) {\r\n                        resolve = resolverMap[aliasUsed ? fieldName : aliasedFieldName];\r\n                        if (resolve) {\r\n                            resultPromise = Promise.resolve(cacheSlot.withValue(this.cache, resolve, [\r\n                                rootValue,\r\n                                argumentsObjectFromField(field, variables),\r\n                                execContext.context,\r\n                                { field: field, fragmentMap: execContext.fragmentMap },\r\n                            ]));\r\n                        }\r\n                    }\r\n                }\r\n                return [2, resultPromise.then(function (result) {\r\n                        if (result === void 0) { result = defaultResult; }\r\n                        if (field.directives) {\r\n                            field.directives.forEach(function (directive) {\r\n                                if (directive.name.value === 'export' && directive.arguments) {\r\n                                    directive.arguments.forEach(function (arg) {\r\n                                        if (arg.name.value === 'as' && arg.value.kind === 'StringValue') {\r\n                                            execContext.exportedVariables[arg.value.value] = result;\r\n                                        }\r\n                                    });\r\n                                }\r\n                            });\r\n                        }\r\n                        if (!field.selectionSet) {\r\n                            return result;\r\n                        }\r\n                        if (result == null) {\r\n                            return result;\r\n                        }\r\n                        if (Array.isArray(result)) {\r\n                            return _this.resolveSubSelectedArray(field, result, execContext);\r\n                        }\r\n                        if (field.selectionSet) {\r\n                            return _this.resolveSelectionSet(field.selectionSet, result, execContext);\r\n                        }\r\n                    })];\r\n            });\r\n        });\r\n    };\r\n    LocalState.prototype.resolveSubSelectedArray = function (field, result, execContext) {\r\n        var _this = this;\r\n        return Promise.all(result.map(function (item) {\r\n            if (item === null) {\r\n                return null;\r\n            }\r\n            if (Array.isArray(item)) {\r\n                return _this.resolveSubSelectedArray(field, item, execContext);\r\n            }\r\n            if (field.selectionSet) {\r\n                return _this.resolveSelectionSet(field.selectionSet, item, execContext);\r\n            }\r\n        }));\r\n    };\r\n    return LocalState;\r\n}());\r\nexport { LocalState };\r\n//# sourceMappingURL=LocalState.js.map"]},"metadata":{},"sourceType":"module"}